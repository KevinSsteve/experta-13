
// This file is automatically generated. Do not edit it directly.
import { createClient } from '@supabase/supabase-js';
import type { Database } from './types';

const SUPABASE_URL = "https://qinlsswojrcuvdudlpvf.supabase.co";
const SUPABASE_PUBLISHABLE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFpbmxzc3dvanJjdXZkdWRscHZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM4ODI1MTAsImV4cCI6MjA1OTQ1ODUxMH0.PvgmJHdjEbwzzg3Je5nYoLb2uZQeWD2qit6iMJ7UFzM";

// Import the supabase client like this:
// import { supabase } from "@/integrations/supabase/client";

export const supabase = createClient<Database>(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY);

// Helper for debugging - logs the current user
export const logCurrentUser = async () => {
  const { data: { user } } = await supabase.auth.getUser();
  console.log("Current user:", user);
  return user;
};

// Busca produtos públicos para sugestões
export const getPublicProducts = async (limit = 20) => {
  try {
    const { data, error } = await supabase
      .from('products')
      .select('*')
      .eq('is_public', true)
      .order('name')
      .limit(limit);
    
    if (error) {
      console.error("Erro ao buscar produtos públicos:", error);
      throw error;
    }
    
    return data;
  } catch (error) {
    console.error("Erro ao buscar produtos públicos:", error);
    return [];
  }
};

// Add a helper function to add a product to user's inventory
export const addProductToInventory = async (product: any, userId: string) => {
  if (!userId) {
    throw new Error("User ID is required to add a product to inventory");
  }
  
  const newProduct = {
    ...product,
    user_id: userId,
    is_public: false,
    stock: product.stock || 10
  };
  
  const { data, error } = await supabase
    .from('products')
    .insert([newProduct])
    .select();
    
  if (error) throw error;
  return data;
};

// Add multiple products to the database as public products
export const addMultiplePublicProducts = async (products: any[], userId: string) => {
  if (!userId) {
    throw new Error("User ID is required to add public products");
  }
  
  // Format products for insertion
  const formattedProducts = products.map(product => ({
    name: product.name,
    price: product.price,
    category: product.category || "Outros",
    stock: product.stock || 50,
    description: product.description || null,
    code: product.code || null,
    image: product.image || "/placeholder.svg",
    user_id: userId,
    is_public: true
  }));
  
  // Insert products in chunks to avoid hitting limits
  const chunkSize = 20;
  const results = [];
  
  for (let i = 0; i < formattedProducts.length; i += chunkSize) {
    const chunk = formattedProducts.slice(i, i + chunkSize);
    const { data, error } = await supabase
      .from('products')
      .insert(chunk);
      
    if (error) {
      console.error(`Error inserting chunk ${i / chunkSize + 1}:`, error);
      throw error;
    }
    
    console.log(`Successfully added chunk ${i / chunkSize + 1} of ${Math.ceil(formattedProducts.length / chunkSize)}`);
    results.push(data);
  }
  
  return results;
};

// Função de diagnóstico para verificar permissões do usuário
export const testPermissions = async () => {
  try {
    // Testa leitura na tabela de produtos
    const { data: products, error: productsError } = await supabase
      .from('products')
      .select('*')
      .limit(1);
    
    // Testa leitura na tabela de vendas
    const { data: sales, error: salesError } = await supabase
      .from('sales')
      .select('*')
      .limit(1);
    
    // Testa perfil do usuário atual
    const { data: profile, error: profileError } = await supabase
      .from('profiles')
      .select('*')
      .single();
    
    return {
      products: {
        success: !productsError,
        data: products,
        error: productsError
      },
      sales: {
        success: !salesError,
        data: sales,
        error: salesError
      },
      profile: {
        success: !profileError,
        data: profile,
        error: profileError
      }
    };
  } catch (error) {
    console.error("Erro ao testar permissões:", error);
    return {
      success: false,
      error
    };
  }
};
